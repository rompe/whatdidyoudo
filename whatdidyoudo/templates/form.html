<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>What Did You Do?</title>
    <link rel="icon" type="image/svg+xml" href="{{ url_for('static', filename='favicon.svg') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <script>
    function isoToday() {
        const t = new Date();
        const yyyy = t.getFullYear();
        const mm = String(t.getMonth() + 1).padStart(2, '0');
        const dd = String(t.getDate()).padStart(2, '0');
        return `${yyyy}-${mm}-${dd}`;
    }

    function initForm() {
        const expert = document.getElementById('expert');
        const expertControls = document.getElementById('expertControls');
        const simpleRow = document.getElementById('simpleDateRow');

    // Initialize dates/time defaults
    const single = document.getElementById('single_date');
    const start_dt = document.getElementById('start_dt');
    const end_dt = document.getElementById('end_dt');

    if (single && !single.value) single.value = isoToday();
    // default datetime-local values: YYYY-MM-DDTHH:MM
    if (start_dt && !start_dt.value) start_dt.value = (single ? single.value : isoToday()) + 'T00:00';
    if (end_dt && !end_dt.value) end_dt.value = (single ? single.value : isoToday()) + 'T23:59';

        // If server rendered the expert checkbox checked, reflect that in UI
        if (expert.checked) {
            expertControls.style.display = '';
            simpleRow.style.display = 'none';
        }

        expert.addEventListener('change', function() {
            if (expert.checked) {
                expertControls.style.display = '';
                simpleRow.style.display = 'none';
                // copy single date into start/end if empty
                if (start_dt && !start_dt.value) start_dt.value = (single ? single.value : isoToday()) + 'T00:00';
                if (end_dt && !end_dt.value) end_dt.value = (single ? single.value : isoToday()) + 'T23:59';
            } else {
                expertControls.style.display = 'none';
                simpleRow.style.display = '';
            }
        });
    }

    function submitForm() {
        const user = encodeURIComponent(document.getElementById('user').value);
        const expert = document.getElementById('expert').checked;
        if (!expert) {
            const date = encodeURIComponent(document.getElementById('single_date').value);
            // keep URL as /user/date
            window.location.href = '/' + user + '/' + date;
            return;
        }
        // expert mode: use datetime-local inputs. We will split them into date and time
        const sd_raw = document.getElementById('start_dt').value; // YYYY-MM-DDTHH:MM
        const ed_raw = document.getElementById('end_dt').value || sd_raw;
        if (!sd_raw) {
            alert('Please provide a start date/time.');
            return;
        }
        const [sd_date, sd_time] = sd_raw.split('T');
        const [ed_date, ed_time] = ed_raw.split('T');
        const qs = `?expert=1&start_time=${encodeURIComponent(sd_time)}&end_time=${encodeURIComponent(ed_time)}`;
        window.location.href = '/' + user + '/' + encodeURIComponent(sd_date) + '/' + encodeURIComponent(ed_date) + qs;
    }

    window.addEventListener('DOMContentLoaded', initForm);
    </script>
</head>
<body>
    <div class="container">
        <h2><a href="/">What Did You Do?</a></h2>
        <form id="mainForm" method="get" action="" onsubmit="event.preventDefault(); submitForm();">
            <label for="user" class="hidden">User:</label>
            <input type="text" id="user" name="user" value="{{ user or '' }}" placeholder="insert OSM username" required>

            <!-- Simple date (default) -->
            <div id="simpleDateRow">
                <label for="single_date" class="hidden">Date:</label>
                <input type="date" id="single_date" name="single_date" value="{{ start_date or '' }}">
            </div>

            <!-- Expert controls (hidden by default) -->
            <div id="expertControls" style="display: none; margin-top: 0.5em;">
                <div class="expert-row">
                    <label for="start_dt">Start:</label>
                    <input type="datetime-local" id="start_dt" name="start_dt"
                     value="{{ (start_date ~ 'T' ~ start_time) if start_date else '' }}">
                </div>
                <div class="expert-row">
                    <label for="end_dt">End:</label>
                    <input type="datetime-local" id="end_dt" name="end_dt"
                     value="{{ ((end_date or start_date) ~ 'T' ~ (end_time or '23:59')) if (end_date or start_date) else '' }}">
                </div>
            </div>

            <div class="expert-toggle">
                <input type="checkbox" id="expert" name="expert"
                 value="1" {{ 'checked' if expert else '' }}>
                <label for="expert">Expert mode</label>
            </div>

            <button type="submit">Show</button>
        </form>
    {% if user %}
        {% for error in errors %}
            <p class=error>{{ error }}</p>
        {% endfor %}
        {% for name, apps in changes.items() %}
            {% set ns = namespace(changes=0, changesets=0) %}
            {% for Change in apps.values() %}
                {% set ns.changes = ns.changes + Change.changes %}
                {% set ns.changesets = ns.changesets + Change.changesets %}
            {% endfor %}
            <ul>
            <p><b><a href="https://www.openstreetmap.org/user/{{ name }}">{{ name }}</a></b>
                 did <b>{{ ns.changes }} change{{ "s" if ns.changes > 1 else ""  }}</b>
                 in {{ ns.changesets }} changeset{{ "s" if ns.changesets > 1 else ""  }}
                 {{ date_str }}:</p>
            {% for app, Change in apps.items() %}
                <li>{{ Change.changes }} change{{ "s" if Change.changes > 1 else ""  }} in
                    {{ Change.changesets }} changeset{{ "s" if Change.changesets > 1 else ""  }}
                    with {{ app }}</li>
            {% endfor %}
            </ul>
        {% endfor %}
    {% else %}
        <p>
            How much did you contribute to <a href="https://www.openstreetmap.org/">OpenStreetMap</a> today? Or any other day?
        </p>
        <p>
            To answer this question, enter your OSM username and the date you want to check above and click "Show".
        </p>
        <div class="note">
            <h4>Tips</h4>
            <ul>
                <li>Do you want to have a bookmark that always shows your numbers for the current day?
                    Just use <code>/YOUR_USERNAME</code> as URL and omit the date!
                </li>
                <li>You can enter multiple usernames separated by commas to see their contributions at once.
                    Try this after a mapwalk with friends!
                </li>
            </ul>
        </div>
        <div class="disclaimer">
            <h4>Disclaimers</h4>
            <ul>
                <li>Quality beats quantity. While it's nice to see big numbers here, please remember
                    that just one high-effort change will help more that any amount of mediocre changes.
                </li>
                <li>This service is rate-limited to 10 OSM API requests per minute and caches results
                    for 1 hour (except for the current day) to reduce load on the API.
                    Too restrictive? Tell me!
                </li>
                <li>This is a very simple service. It does exactly one job and tries to do it good.
                    The data displayed here is shown by many other services, but I didn't find one
                    that answers my question in this way with just a simple bookmark.
                    Suggestions are welcome! Get in touch via the issue tracker on the project page.
                </li>
            </ul>
        </div>
    {% endif %}
        {% if changeset_ids and changeset_ids|length > 0 %}
        <div id="map" style="height: 300px; margin-top: 2em; border-radius: 12px; overflow: hidden;"></div>
        <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
        <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
        <script>
        const changesetIds = JSON.parse('{{ changeset_ids|tojson|safe }}');
        if (changesetIds.length > 0) {
            const bounds = [];
            Promise.all(
                changesetIds.map(id =>
                    fetch(`https://api.openstreetmap.org/api/0.6/changeset/${id}`)
                        .then(r => r.text())
                        .then(xml => {
                            const parser = new DOMParser();
                            const doc = parser.parseFromString(xml, 'application/xml');
                            const cs = doc.querySelector('changeset');
                            if (cs) {
                                bounds.push([
                                    [parseFloat(cs.getAttribute('min_lat')), parseFloat(cs.getAttribute('min_lon'))],
                                    [parseFloat(cs.getAttribute('max_lat')), parseFloat(cs.getAttribute('max_lon'))]
                                ]);
                            }
                        })
                )
            ).then(() => {
                if (bounds.length > 0) {
                    const map = L.map('map').setView([0, 0], 2);
                    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                        maxZoom: 19,
                        attribution: 'Â© OpenStreetMap contributors'
                    }).addTo(map);
                    const allBounds = L.latLngBounds(bounds.flat());
                    map.fitBounds(allBounds);
                    bounds.forEach(b => L.rectangle(b, {color: '#4f8cff', weight: 2}).addTo(map));
                }
            });
        }
        </script>
        {% endif %}
        <p class="footer">Powered by <a href="https://github.com/rompe/whatdidyoudo">whatdidyoudo {{ version }}</a></p>
    </div>
</body>
</html>
