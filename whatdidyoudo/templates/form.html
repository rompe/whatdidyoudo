<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>What Did You Do?</title>
    <link rel="icon" type="image/svg+xml" href="{{ url_for('static', filename='favicon.svg') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <script>
    window.onload = function() {
        var dateInput = document.getElementById('date');
        if (!dateInput.value) {
            var today = new Date();
            var yyyy = today.getFullYear();
            var mm = String(today.getMonth() + 1).padStart(2, '0');
            var dd = String(today.getDate()).padStart(2, '0');
            dateInput.value = yyyy + '-' + mm + '-' + dd;
        }
    };
    </script>
</head>
<body>
    <div class="container">
        <h2><a href="/">What Did You Do?</a></h2>
        <form method="get" action="" onsubmit="event.preventDefault(); window.location.href='/' + encodeURIComponent(document.getElementById('user').value) + '/' + encodeURIComponent(document.getElementById('date').value);">
            <label for="user">User:</label>
            <input type="text" id="user" name="user" value="{{ user or '' }}" placeholder="insert OSM username" required>

            <label for="date">Date:</label>
            <input type="date" id="date" name="date" value="{{ date or '' }}" required>

            <button type="submit">Show</button>
        </form>
    {% if user and date %}
        {% for error in errors %}
            <p class=error>{{ error }}</p>
        {% endfor %}
        {% for name, apps in changes.items() %}
            {% set ns = namespace(changes=0, changesets=0) %}
            {% for Change in apps.values() %}
                {% set ns.changes = ns.changes + Change.changes %}
                {% set ns.changesets = ns.changesets + Change.changesets %}
            {% endfor %}
            <ul>
            <p><a href="https://www.openstreetmap.org/user/{{ user }}">{{ name }}</a>
                 did {{ ns.changes }} change{{ "s" if ns.changes > 1 else ""  }}
                 in {{ ns.changesets }} changeset{{ "s" if ns.changesets > 1 else ""  }}
                 on {{ date }}:</p>
            {% for app, Change in apps.items() %}
                <li>{{ Change.changes }} change{{ "s" if Change.changes > 1 else ""  }} in
                    {{ Change.changesets }} changeset{{ "s" if Change.changesets > 1 else ""  }}
                    with {{ app }}</li>
            {% endfor %}
            </ul>
        {% endfor %}
    {% else %}
        <p>
            How much did you contribute to <a href="https://www.openstreetmap.org/">OpenStreetMap</a> today? Or any other day?
        </p>
        <p>
            To answer this question, enter your OSM username and the date you want to check above and click "Show".
        </p>
        <div class="note">
            <h4>Tips</h4>
            <ul>
                <li>Do you want to have a bookmark that always shows your numbers for the current day?
                    Just use <code>/YOUR_USERNAME</code> as URL and omit the date!
                </li>
                <li>You can enter multiple usernames separated by commas to see their contributions at once.
                    Try this after a mapwalk with friends!
                </li>
            </ul>
        </div>
        <div class="disclaimer">
            <h4>Disclaimers</h4>
            <ul>
                <li>Quality beats quantity. While it's nice to see big numbers here, please remember
                    that just one high-effort change will help more that any amount of mediocre changes.
                </li>
                <li>This service is rate-limited to 10 OSM API requests per minute and caches results
                    for 1 hour (except for the current day) to reduce load on the API.
                    Too restrictive? Tell me!
                </li>
                <li>This is a very simple service. It does exactly one job and tries to do it good.
                    The data displayed here is shown by many other services, but I didn't find one
                    that answers my question in this way with just a simple bookmark.
                    Suggestions are welcome! Get in touch via the issue tracker on the project page.
                </li>
            </ul>
        </div>
    {% endif %}
        {% if changeset_ids and changeset_ids|length > 0 %}
        <div id="map" style="height: 300px; margin-top: 2em; border-radius: 12px; overflow: hidden;"></div>
        <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
        <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
        <script>
        const changesetIds = {{ changeset_ids|tojson }};
        if (changesetIds.length > 0) {
            const bounds = [];
            Promise.all(
                changesetIds.map(id =>
                    fetch(`https://api.openstreetmap.org/api/0.6/changeset/${id}`)
                        .then(r => r.text())
                        .then(xml => {
                            const parser = new DOMParser();
                            const doc = parser.parseFromString(xml, 'application/xml');
                            const cs = doc.querySelector('changeset');
                            if (cs) {
                                bounds.push([
                                    [parseFloat(cs.getAttribute('min_lat')), parseFloat(cs.getAttribute('min_lon'))],
                                    [parseFloat(cs.getAttribute('max_lat')), parseFloat(cs.getAttribute('max_lon'))]
                                ]);
                            }
                        })
                )
            ).then(() => {
                if (bounds.length > 0) {
                    const map = L.map('map').setView([0, 0], 2);
                    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                        maxZoom: 19,
                        attribution: 'Â© OpenStreetMap contributors'
                    }).addTo(map);
                    const allBounds = L.latLngBounds(bounds.flat());
                    map.fitBounds(allBounds);
                    bounds.forEach(b => L.rectangle(b, {color: '#4f8cff', weight: 2}).addTo(map));
                }
            });
        }
        </script>
        {% endif %}
        <p class="footer">Powered by <a href="https://github.com/rompe/whatdidyoudo">whatdidyoudo {{ version }}</a></p>
    </div>
</body>
</html>
